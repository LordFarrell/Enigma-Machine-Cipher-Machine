<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enigma Machine Simulator</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Courier New', monospace;
    background: #1a1a1a;
    color: #e0e0e0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
}

.enigma-container {
    max-width: 1200px;
    width: 100%;
    background: linear-gradient(135deg, #2c1810 0%, #1a0f08 100%);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    position: relative;
}

.enigma-container::before {
    content: '';
    position: absolute;
    inset: -2px;
    background: linear-gradient(45deg, #8b6914, #cd9f3e, #8b6914);
    border-radius: 20px;
    z-index: -1;
}

h1 {
    text-align: center;
    color: #cd9f3e;
    margin-bottom: 30px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    font-size: 2.5em;
}

/* Signal Path Visualization */
.signal-visualization {
    background: #0a0a0a;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid #3a3a3a;
    display: none;
}

.signal-visualization.active {
    display: block;
}

.signal-flow {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 20px 0;
    position: relative;
}

.signal-component {
    background: #1a1a1a;
    border: 2px solid #444;
    border-radius: 10px;
    padding: 15px;
    text-align: center;
    position: relative;
    z-index: 2;
}

.signal-component.active {
    border-color: #ffcc44;
    box-shadow: 0 0 15px rgba(255, 204, 68, 0.8);
}

.signal-arrow {
    position: absolute;
    top: 50%;
    width: 40px;
    height: 2px;
    background: #444;
    transform: translateY(-50%);
}

.signal-arrow.active {
    background: #ffcc44;
    animation: arrowPulse 0.5s ease-in-out;
}

@keyframes arrowPulse {
    0% { opacity: 0; width: 0; }
    50% { opacity: 1; }
    100% { opacity: 1; width: 40px; }
}

.signal-detail {
    background: #111;
    border-radius: 10px;
    padding: 10px;
    margin-top: 10px;
    font-size: 0.9em;
    display: none;
}

.signal-detail.show {
    display: block;
}

/* Rotor Section */
.rotor-section {
    background: #0a0a0a;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid #3a3a3a;
}

.rotor-controls {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.rotor-unit {
    background: #1a1a1a;
    border-radius: 10px;
    padding: 15px;
    border: 1px solid #444;
}

.rotor-window {
    background: #000;
    color: #fff;
    font-size: 3em;
    text-align: center;
    padding: 10px;
    border-radius: 10px;
    margin: 10px 0;
    border: 3px solid #444;
    position: relative;
    overflow: hidden;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.rotor-window.stepping {
    animation: rotorStep 0.3s ease-in-out;
}

@keyframes rotorStep {
    0% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0); }
}

.rotor-controls select, .rotor-controls input {
    width: 100%;
    padding: 8px;
    margin: 5px 0;
    background: #2a2a2a;
    color: #e0e0e0;
    border: 1px solid #444;
    border-radius: 5px;
}

/* Plugboard Section */
.plugboard-section {
    background: #0a0a0a;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid #3a3a3a;
}

.plugboard-container {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
}

.plug-row {
    display: grid;
    grid-template-columns: repeat(13, 1fr);
    gap: 10px;
}

.plug-socket {
    width: 40px;
    height: 40px;
    background: #2a2a2a;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #555;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.plug-socket:hover {
    background: #3a3a3a;
    border-color: #cd9f3e;
}

.plug-socket.connected {
    background: #cd9f3e;
    border-color: #ffcc44;
    box-shadow: 0 0 10px rgba(205, 159, 62, 0.5);
}

.plug-socket.signal-active {
    animation: plugSignal 0.5s ease-in-out;
}

@keyframes plugSignal {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); box-shadow: 0 0 20px #ffcc44; }
}

.plug-cable {
    position: absolute;
    height: 2px;
    background: #cd9f3e;
    transform-origin: left center;
    pointer-events: none;
    z-index: 10;
}

/* Keyboard Section */
.keyboard-section {
    background: #0a0a0a;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid #3a3a3a;
}

.keyboard {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 10px;
    max-width: 600px;
    margin: 0 auto;
}

.key {
    aspect-ratio: 1;
    background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
    border: 2px solid #555;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5em;
    cursor: pointer;
    transition: all 0.1s;
    position: relative;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.key:hover {
    background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
}

.key:active, .key.active {
    transform: translateY(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
}

/* Lamp Panel */
.lamp-panel {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 10px;
    max-width: 600px;
    margin: 20px auto;
}

.lamp {
    aspect-ratio: 1;
    background: #1a1a1a;
    border: 2px solid #333;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3em;
    transition: all 0.3s;
}

.lamp.lit {
    background: #ffcc44;
    color: #000;
    box-shadow: 0 0 20px rgba(255, 204, 68, 0.8);
    animation: lampGlow 0.5s ease-in-out;
}

@keyframes lampGlow {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* Input/Output Section */
.io-section {
    background: #0a0a0a;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid #3a3a3a;
}

.io-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

textarea {
    width: 100%;
    height: 150px;
    background: #1a1a1a;
    color: #e0e0e0;
    border: 1px solid #444;
    border-radius: 10px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 1.1em;
    resize: vertical;
}

/* Message History */
.history-section {
    background: #0a0a0a;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid #3a3a3a;
    display: none;
}

.history-section.active {
    display: block;
}

.history-list {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 15px;
}

.history-item {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #333;
}

.history-item .timestamp {
    color: #cd9f3e;
    font-size: 0.9em;
}

/* Frequency Analysis */
.analysis-section {
    background: #0a0a0a;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid #3a3a3a;
    display: none;
}

.analysis-section.active {
    display: block;
}

.frequency-chart {
    display: grid;
    grid-template-columns: repeat(13, 1fr);
    gap: 10px;
    margin-top: 20px;
}

.freq-bar {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.freq-bar-fill {
    background: #cd9f3e;
    width: 30px;
    transition: height 0.3s;
    border-radius: 5px 5px 0 0;
}

.freq-letter {
    margin-top: 5px;
    font-weight: bold;
}

/* Cryptanalysis Section */
.cryptanalysis-section {
    background: #0a0a0a;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    border: 2px solid #3a3a3a;
    display: none;
}

.cryptanalysis-section.active {
    display: block;
}

.crib-input {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
}

.attack-results {
    background: #111;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
    max-height: 400px;
    overflow-y: auto;
}

.attack-result {
    background: #1a1a1a;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #333;
}

.attack-result.match {
    border-color: #cd9f3e;
    background: #2a1a0a;
}

/* Control Buttons */
.controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 20px;
}

button {
    padding: 12px 24px;
    background: linear-gradient(135deg, #cd9f3e 0%, #8b6914 100%);
    color: #000;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

button:hover {
    background: linear-gradient(135deg, #ffcc44 0%, #cd9f3e 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
}

button:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* Settings Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: #1a1a1a;
    border-radius: 15px;
    padding: 30px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid #cd9f3e;
}

.close-modal {
    float: right;
    font-size: 2em;
    cursor: pointer;
    color: #cd9f3e;
}

.close-modal:hover {
    color: #ffcc44;
}

/* Mode Toggle */
.mode-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    justify-content: center;
    flex-wrap: wrap;
}

.mode-toggle label {
    display: flex;
    align-items: center;
    gap: 5px;
    cursor: pointer;
}

/* Tabs */
.tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 2px solid #3a3a3a;
}

.tab {
    padding: 10px 20px;
    background: #2a2a2a;
    border: none;
    border-radius: 10px 10px 0 0;
    cursor: pointer;
    transition: all 0.3s;
}

.tab.active {
    background: #3a3a3a;
    color: #cd9f3e;
}

/* Responsive */
@media (max-width: 768px) {
    .rotor-controls {
        grid-template-columns: 1fr;
    }
    
    .io-container {
        grid-template-columns: 1fr;
    }
    
    .keyboard, .lamp-panel {
        grid-template-columns: repeat(9, 1fr);
    }
    
    .frequency-chart {
        grid-template-columns: repeat(6, 1fr);
    }
}
</style>
</head>
<body>
<div class="enigma-container">
    <h1>ENIGMA MACHINE</h1>
    
    <!-- Mode Toggle -->
    <div class="mode-toggle">
        <label>
            <input type="checkbox" id="educationalMode">
            Educational Mode
        </label>
        <label>
            <input type="checkbox" id="autoSpacing" checked>
            5-Letter Groups
        </label>
        <label>
            <input type="checkbox" id="showHistory">
            Message History
        </label>
        <label>
            <input type="checkbox" id="showAnalysis">
            Frequency Analysis
        </label>
        <label>
            <input type="checkbox" id="showCryptanalysis">
            Cryptanalysis Tools
        </label>
    </div>
    
    <!-- Signal Visualization -->
    <div class="signal-visualization" id="signalVisualization">
        <h2>Signal Path Visualization</h2>
        <div class="signal-flow">
            <div class="signal-component" id="signal-input">
                <h4>Input</h4>
                <div class="signal-detail" id="input-detail"></div>
            </div>
            <div class="signal-arrow" style="left: 120px;"></div>
            
            <div class="signal-component" id="signal-plugboard1">
                <h4>Plugboard</h4>
                <div class="signal-detail" id="plug1-detail"></div>
            </div>
            <div class="signal-arrow" style="left: 260px;"></div>
            
            <div class="signal-component" id="signal-rotor3">
                <h4>Rotor III</h4>
                <div class="signal-detail" id="rotor3-detail"></div>
            </div>
            <div class="signal-arrow" style="left: 400px;"></div>
            
            <div class="signal-component" id="signal-rotor2">
                <h4>Rotor II</h4>
                <div class="signal-detail" id="rotor2-detail"></div>
            </div>
            <div class="signal-arrow" style="left: 540px;"></div>
            
            <div class="signal-component" id="signal-rotor1">
                <h4>Rotor I</h4>
                <div class="signal-detail" id="rotor1-detail"></div>
            </div>
            <div class="signal-arrow" style="left: 680px;"></div>
            
            <div class="signal-component" id="signal-reflector">
                <h4>Reflector</h4>
                <div class="signal-detail" id="reflector-detail"></div>
            </div>
        </div>
        
        <div class="signal-flow" style="margin-top: 20px;">
            <div class="signal-component" id="signal-output">
                <h4>Output</h4>
                <div class="signal-detail" id="output-detail"></div>
            </div>
            <div class="signal-arrow" style="right: 120px; left: auto;"></div>
            
            <div class="signal-component" id="signal-plugboard2">
                <h4>Plugboard</h4>
                <div class="signal-detail" id="plug2-detail"></div>
            </div>
            <div class="signal-arrow" style="right: 260px; left: auto;"></div>
            
            <div class="signal-component" id="signal-rotor3b">
                <h4>Rotor III</h4>
                <div class="signal-detail" id="rotor3b-detail"></div>
            </div>
            <div class="signal-arrow" style="right: 400px; left: auto;"></div>
            
            <div class="signal-component" id="signal-rotor2b">
                <h4>Rotor II</h4>
                <div class="signal-detail" id="rotor2b-detail"></div>
            </div>
            <div class="signal-arrow" style="right: 540px; left: auto;"></div>
            
            <div class="signal-component" id="signal-rotor1b">
                <h4>Rotor I</h4>
                <div class="signal-detail" id="rotor1b-detail"></div>
            </div>
        </div>
    </div>
    
    <!-- Rotor Section -->
    <div class="rotor-section">
        <h2>Rotors</h2>
        <div class="rotor-controls">
            <div class="rotor-unit">
                <h3>Left Rotor</h3>
                <select id="leftRotorType">
                    <option value="I">Rotor I</option>
                    <option value="II">Rotor II</option>
                    <option value="III">Rotor III</option>
                    <option value="IV">Rotor IV</option>
                    <option value="V">Rotor V</option>
                </select>
                <div class="rotor-window" id="leftWindow">A</div>
                <label>Position: <input type="text" id="leftPosition" value="A" maxlength="1"></label>
                <label>Ring: <input type="number" id="leftRing" value="1" min="1" max="26"></label>
            </div>
            
            <div class="rotor-unit">
                <h3>Middle Rotor</h3>
                <select id="middleRotorType">
                    <option value="I">Rotor I</option>
                    <option value="II" selected>Rotor II</option>
                    <option value="III">Rotor III</option>
                    <option value="IV">Rotor IV</option>
                    <option value="V">Rotor V</option>
                </select>
                <div class="rotor-window" id="middleWindow">A</div>
                <label>Position: <input type="text" id="middlePosition" value="A" maxlength="1"></label>
                <label>Ring: <input type="number" id="middleRing" value="1" min="1" max="26"></label>
            </div>
            
            <div class="rotor-unit">
                <h3>Right Rotor</h3>
                <select id="rightRotorType">
                    <option value="I">Rotor I</option>
                    <option value="II">Rotor II</option>
                    <option value="III" selected>Rotor III</option>
                    <option value="IV">Rotor IV</option>
                    <option value="V">Rotor V</option>
                </select>
                <div class="rotor-window" id="rightWindow">A</div>
                <label>Position: <input type="text" id="rightPosition" value="A" maxlength="1"></label>
                <label>Ring: <input type="number" id="rightRing" value="1" min="1" max="26"></label>
            </div>
        </div>
    </div>
    
    <!-- Plugboard Section -->
    <div class="plugboard-section">
        <h2>Plugboard (Steckerbrett)</h2>
        <div class="plugboard-container">
            <div class="plug-row" id="plugboard">
                <!-- Generated by JavaScript -->
            </div>
        </div>
        <div id="plugboardConnections" style="text-align: center; margin-top: 10px;"></div>
    </div>
    
    <!-- Lamp Panel -->
    <div class="keyboard-section">
        <h2>Output Lamps</h2>
        <div class="lamp-panel" id="lampPanel">
            <!-- Generated by JavaScript -->
        </div>
    </div>
    
    <!-- Keyboard -->
    <div class="keyboard-section">
        <h2>Keyboard</h2>
        <div class="keyboard" id="keyboard">
            <!-- Generated by JavaScript -->
        </div>
    </div>
    
    <!-- Input/Output -->
    <div class="io-section">
        <h2>Message Input/Output</h2>
        <div class="io-container">
            <div>
                <h3>Input</h3>
                <textarea id="inputText" placeholder="Type your message here..."></textarea>
            </div>
            <div>
                <h3>Output</h3>
                <textarea id="outputText" readonly placeholder="Encrypted/Decrypted message appears here..."></textarea>
            </div>
        </div>
    </div>
    
    <!-- Message History -->
    <div class="history-section" id="historySection">
        <h2>Message History</h2>
        <button onclick="clearHistory()" style="float: right;">Clear History</button>
        <div class="history-list" id="historyList"></div>
    </div>
    
    <!-- Frequency Analysis -->
    <div class="analysis-section" id="analysisSection">
        <h2>Frequency Analysis</h2>
        <div class="tabs">
            <button class="tab active" onclick="showAnalysisTab('input')">Input Text</button>
            <button class="tab" onclick="showAnalysisTab('output')">Output Text</button>
            <button class="tab" onclick="showAnalysisTab('comparison')">Comparison</button>
        </div>
        <div id="analysisContent">
            <div class="frequency-chart" id="frequencyChart"></div>
            <div style="margin-top: 20px;">
                <p>Index of Coincidence: <span id="iocValue">0.000</span></p>
                <p>Chi-squared statistic: <span id="chiSquared">0.000</span></p>
            </div>
        </div>
    </div>
    
    <!-- Cryptanalysis Tools -->
    <div class="cryptanalysis-section" id="cryptanalysisSection">
        <h2>Cryptanalysis Tools</h2>
        <div class="tabs">
            <button class="tab active" onclick="showCryptTab('cribdrag')">Crib Dragging</button>
            <button class="tab" onclick="showCryptTab('bruteforce')">Rotor Positions</button>
            <button class="tab" onclick="showCryptTab('plugboard')">Plugboard Analysis</button>
        </div>
        
        <div id="cribDragTab">
            <h3>Known Plaintext Attack (Crib Dragging)</h3>
            <div class="crib-input">
                <div>
                    <label>Known Plaintext (Crib):</label>
                    <textarea id="cribText" placeholder="Enter known plaintext..." style="height: 80px;"></textarea>
                </div>
                <div>
                    <label>Ciphertext to Attack:</label>
                    <textarea id="cipherText" placeholder="Enter ciphertext..." style="height: 80px;"></textarea>
                </div>
            </div>
            <button onclick="performCribAttack()">Start Crib Attack</button>
            <div class="attack-results" id="cribResults"></div>
        </div>
        
        <div id="bruteForceTab" style="display: none;">
            <h3>Brute Force Rotor Positions</h3>
            <p>Test all rotor starting positions for the current rotor configuration.</p>
            <label>Test phrase: <input type="text" id="testPhrase" value="HELLO" style="background: #2a2a2a; color: #e0e0e0; border: 1px solid #444; padding: 5px;"></label>
            <button onclick="bruteForceRotors()">Start Brute Force</button>
            <div class="attack-results" id="bruteResults"></div>
        </div>
        
        <div id="plugboardTab" style="display: none;">
            <h3>Plugboard Deduction</h3>
            <p>Analyze letter patterns to suggest plugboard connections.</p>
            <button onclick="analyzePlugboard()">Analyze Current Text</button>
            <div class="attack-results" id="plugboardResults"></div>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="controls">
        <button onclick="processText()">Process Text</button>
        <button onclick="clearAll()">Clear All</button>
        <button onclick="resetMachine()">Reset Machine</button>
        <button onclick="copyOutput()">Copy Output</button>
        <button onclick="showSettings()">Settings</button>
        <button onclick="saveConfig()">Save Config</button>
        <button onclick="loadConfig()">Load Config</button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeSettings()">&times;</span>
        <h2>Settings & Configuration</h2>
        <div style="margin-top: 20px;">
            <h3>Configuration Code</h3>
            <textarea id="configCode" style="height: 100px;" placeholder="Paste configuration code here..."></textarea>
            <div style="margin-top: 10px;">
                <button onclick="exportConfig()">Export Current Config</button>
                <button onclick="importConfig()">Import Config</button>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <h3>Historical Presets</h3>
            <button onclick="loadPreset('default')">Default Settings</button>
            <button onclick="loadPreset('historical1')">Wehrmacht Daily Key</button>
            <button onclick="loadPreset('historical2')">Kriegsmarine Setting</button>
        </div>
    </div>
</div>

<script>
// Enigma Machine Implementation

// Rotor wirings (historically accurate)
const ROTORS = {
    I: {
        wiring: "EKMFLGDQVZNTOWYHXUSPAIBRCJ",
        notch: "Q"
    },
    II: {
        wiring: "AJDKSIRUXBLHWTMCQGZNPYFVOE",
        notch: "E"
    },
    III: {
        wiring: "BDFHJLCPRTXVZNYEIWGAKMUSQO",
        notch: "V"
    },
    IV: {
        wiring: "ESOVPZJAYQUIRHXLNFTGKDCMWB",
        notch: "J"
    },
    V: {
        wiring: "VZBRGITYUPSDNHLXAWMJQOFECK",
        notch: "Z"
    }
};

// Reflector B wiring
const REFLECTOR_B = "YRUHQSLDPXNGOKMIEBFZCWVJAT";

// Machine state
let machineState = {
    leftRotor: { type: 'I', position: 0, ring: 0 },
    middleRotor: { type: 'II', position: 0, ring: 0 },
    rightRotor: { type: 'III', position: 0, ring: 0 },
    plugboard: {},
    plugboardPairs: []
};

// Plugboard connection state
let plugboardConnection = {
    first: null,
    cables: []
};

// Message history
let messageHistory = [];

// Analysis state
let analysisTab = 'input';
let cryptTab = 'cribdrag';

// Initialize the machine
function initializeMachine() {
    createKeyboard();
    createLampPanel();
    createPlugboard();
    updateRotorDisplays();
    attachEventListeners();
}

// Create QWERTZ keyboard
function createKeyboard() {
    const qwertzLayout = "QWERTZUIOP ASDFGHJKL YXCVBNM";
    const keyboard = document.getElementById('keyboard');
    keyboard.innerHTML = '';
    
    for (let char of qwertzLayout) {
        if (char === ' ') continue;
        const key = document.createElement('div');
        key.className = 'key';
        key.textContent = char;
        key.dataset.letter = char;
        key.onclick = () => pressKey(char);
        keyboard.appendChild(key);
    }
}

// Create lamp panel
function createLampPanel() {
    const lampPanel = document.getElementById('lampPanel');
    lampPanel.innerHTML = '';
    const qwertzLayout = "QWERTZUIOP ASDFGHJKL YXCVBNM";
    
    for (let char of qwertzLayout) {
        if (char === ' ') continue;
        const lamp = document.createElement('div');
        lamp.className = 'lamp';
        lamp.textContent = char;
        lamp.dataset.letter = char;
        lampPanel.appendChild(lamp);
    }
}

// Create plugboard
function createPlugboard() {
    const plugboard = document.getElementById('plugboard');
    plugboard.innerHTML = '';
    
    for (let i = 0; i < 26; i++) {
        const letter = String.fromCharCode(65 + i);
        const socket = document.createElement('div');
        socket.className = 'plug-socket';
        socket.textContent = letter;
        socket.dataset.letter = letter;
        socket.onclick = () => togglePlug(letter);
        plugboard.appendChild(socket);
    }
}

// Toggle plugboard connection
function togglePlug(letter) {
    const socket = document.querySelector(`.plug-socket[data-letter="${letter}"]`);
    
    if (machineState.plugboard[letter]) {
        // Remove existing connection
        const partner = machineState.plugboard[letter];
        delete machineState.plugboard[letter];
        delete machineState.plugboard[partner];
        
        // Update visual state
        document.querySelector(`.plug-socket[data-letter="${letter}"]`).classList.remove('connected');
        document.querySelector(`.plug-socket[data-letter="${partner}"]`).classList.remove('connected');
        
        // Remove from pairs
        machineState.plugboardPairs = machineState.plugboardPairs.filter(
            pair => !(pair.includes(letter) && pair.includes(partner))
        );
        
        updatePlugboardDisplay();
        return;
    }
    
    if (!plugboardConnection.first) {
        plugboardConnection.first = letter;
        socket.classList.add('connected');
    } else if (plugboardConnection.first === letter) {
        plugboardConnection.first = null;
        socket.classList.remove('connected');
    } else {
        // Create connection
        const first = plugboardConnection.first;
        machineState.plugboard[first] = letter;
        machineState.plugboard[letter] = first;
        machineState.plugboardPairs.push([first, letter]);
        
        document.querySelector(`.plug-socket[data-letter="${first}"]`).classList.add('connected');
        socket.classList.add('connected');
        
        plugboardConnection.first = null;
        updatePlugboardDisplay();
    }
}

// Update plugboard display
function updatePlugboardDisplay() {
    const display = document.getElementById('plugboardConnections');
    if (machineState.plugboardPairs.length > 0) {
        display.textContent = 'Connections: ' + 
            machineState.plugboardPairs.map(pair => pair.join('-')).join(', ');
    } else {
        display.textContent = 'No connections';
    }
}

// Update rotor window displays
function updateRotorDisplays() {
    document.getElementById('leftWindow').textContent = 
        String.fromCharCode(65 + machineState.leftRotor.position);
    document.getElementById('middleWindow').textContent = 
        String.fromCharCode(65 + machineState.middleRotor.position);
    document.getElementById('rightWindow').textContent = 
        String.fromCharCode(65 + machineState.rightRotor.position);
}

// Attach event listeners
function attachEventListeners() {
    // Rotor type changes
    document.getElementById('leftRotorType').onchange = (e) => {
        machineState.leftRotor.type = e.target.value;
    };
    document.getElementById('middleRotorType').onchange = (e) => {
        machineState.middleRotor.type = e.target.value;
    };
    document.getElementById('rightRotorType').onchange = (e) => {
        machineState.rightRotor.type = e.target.value;
    };
    
    // Position changes
    document.getElementById('leftPosition').oninput = (e) => {
        const char = e.target.value.toUpperCase();
        if (/^[A-Z]$/.test(char)) {
            machineState.leftRotor.position = char.charCodeAt(0) - 65;
            updateRotorDisplays();
        }
    };
    document.getElementById('middlePosition').oninput = (e) => {
        const char = e.target.value.toUpperCase();
        if (/^[A-Z]$/.test(char)) {
            machineState.middleRotor.position = char.charCodeAt(0) - 65;
            updateRotorDisplays();
        }
    };
    document.getElementById('rightPosition').oninput = (e) => {
        const char = e.target.value.toUpperCase();
        if (/^[A-Z]$/.test(char)) {
            machineState.rightRotor.position = char.charCodeAt(0) - 65;
            updateRotorDisplays();
        }
    };
    
    // Ring settings
    document.getElementById('leftRing').onchange = (e) => {
        machineState.leftRotor.ring = parseInt(e.target.value) - 1;
    };
    document.getElementById('middleRing').onchange = (e) => {
        machineState.middleRotor.ring = parseInt(e.target.value) - 1;
    };
    document.getElementById('rightRing').onchange = (e) => {
        machineState.rightRotor.ring = parseInt(e.target.value) - 1;
    };
    
    // Text input
    document.getElementById('inputText').oninput = (e) => {
        if (document.getElementById('educationalMode').checked) {
            processTextEducational();
        }
    };
    
    // Mode toggles
    document.getElementById('educationalMode').onchange = (e) => {
        document.getElementById('signalVisualization').classList.toggle('active', e.target.checked);
    };
    
    document.getElementById('showHistory').onchange = (e) => {
        document.getElementById('historySection').classList.toggle('active', e.target.checked);
    };
    
    document.getElementById('showAnalysis').onchange = (e) => {
        document.getElementById('analysisSection').classList.toggle('active', e.target.checked);
        if (e.target.checked) {
            updateFrequencyAnalysis();
        }
    };
    
    document.getElementById('showCryptanalysis').onchange = (e) => {
        document.getElementById('cryptanalysisSection').classList.toggle('active', e.target.checked);
    };
}

// Step rotors before encryption
function stepRotors() {
    const rightRotor = machineState.rightRotor;
    const middleRotor = machineState.middleRotor;
    const leftRotor = machineState.leftRotor;
    
    // Check for double-stepping
    const middleNotch = ROTORS[middleRotor.type].notch.charCodeAt(0) - 65;
    const rightNotch = ROTORS[rightRotor.type].notch.charCodeAt(0) - 65;
    
    // Middle rotor is at notch position (double-stepping)
    if (middleRotor.position === middleNotch) {
        middleRotor.position = (middleRotor.position + 1) % 26;
        leftRotor.position = (leftRotor.position + 1) % 26;
        
        // Animate
        document.getElementById('middleWindow').classList.add('stepping');
        document.getElementById('leftWindow').classList.add('stepping');
        setTimeout(() => {
            document.getElementById('middleWindow').classList.remove('stepping');
            document.getElementById('leftWindow').classList.remove('stepping');
        }, 300);
    }
    
    // Right rotor is at notch position
    if (rightRotor.position === rightNotch) {
        middleRotor.position = (middleRotor.position + 1) % 26;
        
        // Animate
        document.getElementById('middleWindow').classList.add('stepping');
        setTimeout(() => {
            document.getElementById('middleWindow').classList.remove('stepping');
        }, 300);
    }
    
    // Always step right rotor
    rightRotor.position = (rightRotor.position + 1) % 26;
    
    // Animate right rotor
    document.getElementById('rightWindow').classList.add('stepping');
    setTimeout(() => {
        document.getElementById('rightWindow').classList.remove('stepping');
    }, 300);
    
    updateRotorDisplays();
}

// Encode through rotor
function encodeRotor(char, rotor, reverse = false) {
    const offset = rotor.position - rotor.ring;
    const wiring = ROTORS[rotor.type].wiring;
    
    if (!reverse) {
        // Forward direction
        let pos = (char + offset + 26) % 26;
        let encoded = wiring.charCodeAt(pos) - 65;
        return (encoded - offset + 26) % 26;
    } else {
        // Reverse direction
        let pos = (char + offset + 26) % 26;
        let encoded = wiring.indexOf(String.fromCharCode(pos + 65));
        return (encoded - offset + 26) % 26;
    }
}

// Encode through reflector
function encodeReflector(char) {
    return REFLECTOR_B.charCodeAt(char) - 65;
}

// Encode character through entire machine
function encodeChar(charCode, trackPath = false) {
    const path = trackPath ? {} : null;
    
    // Plugboard in
    let char = charCode;
    const inputLetter = String.fromCharCode(charCode + 65);
    if (path) path.input = inputLetter;
    
    if (machineState.plugboard[inputLetter]) {
        char = machineState.plugboard[inputLetter].charCodeAt(0) - 65;
        if (path) path.plug1 = `${inputLetter} → ${String.fromCharCode(char + 65)}`;
    } else {
        if (path) path.plug1 = `${inputLetter} → ${inputLetter}`;
    }
    
    // Through rotors (right to left)
    let beforeRotor3 = char;
    char = encodeRotor(char, machineState.rightRotor);
    if (path) path.rotor3 = `${String.fromCharCode(beforeRotor3 + 65)} → ${String.fromCharCode(char + 65)}`;
    
    let beforeRotor2 = char;
    char = encodeRotor(char, machineState.middleRotor);
    if (path) path.rotor2 = `${String.fromCharCode(beforeRotor2 + 65)} → ${String.fromCharCode(char + 65)}`;
    
    let beforeRotor1 = char;
    char = encodeRotor(char, machineState.leftRotor);
    if (path) path.rotor1 = `${String.fromCharCode(beforeRotor1 + 65)} → ${String.fromCharCode(char + 65)}`;
    
    // Through reflector
    let beforeReflector = char;
    char = encodeReflector(char);
    if (path) path.reflector = `${String.fromCharCode(beforeReflector + 65)} → ${String.fromCharCode(char + 65)}`;
    
    // Back through rotors (left to right)
    let beforeRotor1b = char;
    char = encodeRotor(char, machineState.leftRotor, true);
    if (path) path.rotor1b = `${String.fromCharCode(beforeRotor1b + 65)} → ${String.fromCharCode(char + 65)}`;
    
    let beforeRotor2b = char;
    char = encodeRotor(char, machineState.middleRotor, true);
    if (path) path.rotor2b = `${String.fromCharCode(beforeRotor2b + 65)} → ${String.fromCharCode(char + 65)}`;
    
    let beforeRotor3b = char;
    char = encodeRotor(char, machineState.rightRotor, true);
    if (path) path.rotor3b = `${String.fromCharCode(beforeRotor3b + 65)} → ${String.fromCharCode(char + 65)}`;
    
    // Plugboard out
    const outputLetter = String.fromCharCode(char + 65);
    if (machineState.plugboard[outputLetter]) {
        char = machineState.plugboard[outputLetter].charCodeAt(0) - 65;
        if (path) path.plug2 = `${outputLetter} → ${String.fromCharCode(char + 65)}`;
    } else {
        if (path) path.plug2 = `${outputLetter} → ${outputLetter}`;
    }
    
    if (path) {
        path.output = String.fromCharCode(char + 65);
        return { char, path };
    }
    
    return char;
}

// Press key and encrypt
function pressKey(letter) {
    // Visual feedback
    const key = document.querySelector(`.key[data-letter="${letter}"]`);
    key.classList.add('active');
    setTimeout(() => key.classList.remove('active'), 200);
    
    // Step rotors
    stepRotors();
    
    // Encrypt with path tracking if educational mode
    const inputCode = letter.charCodeAt(0) - 65;
    const educational = document.getElementById('educationalMode').checked;
    
    let outputCode, signalPath;
    if (educational) {
        const result = encodeChar(inputCode, true);
        outputCode = result.char;
        signalPath = result.path;
    } else {
        outputCode = encodeChar(inputCode);
    }
    
    const outputLetter = String.fromCharCode(outputCode + 65);
    
    // Light up lamp
    const lamps = document.querySelectorAll('.lamp');
    lamps.forEach(lamp => lamp.classList.remove('lit'));
    const outputLamp = document.querySelector(`.lamp[data-letter="${outputLetter}"]`);
    outputLamp.classList.add('lit');
    
    // Add to output
    const outputText = document.getElementById('outputText');
    let currentOutput = outputText.value;
    
    if (document.getElementById('autoSpacing').checked) {
        // Remove spaces and count letters
        const cleanOutput = currentOutput.replace(/\s/g, '');
        if (cleanOutput.length > 0 && cleanOutput.length % 5 === 0) {
            currentOutput += ' ';
        }
    }
    
    outputText.value = currentOutput + outputLetter;
    
    // Educational mode visualization
    if (educational && signalPath) {
        animateSignalPath(signalPath);
    }
    
    // Update frequency analysis if active
    if (document.getElementById('showAnalysis').checked) {
        updateFrequencyAnalysis();
    }
    
    return outputLetter;
}

// Animate signal path through machine
function animateSignalPath(path) {
    const components = [
        { id: 'signal-input', detail: 'input-detail', value: path.input },
        { id: 'signal-plugboard1', detail: 'plug1-detail', value: path.plug1 },
        { id: 'signal-rotor3', detail: 'rotor3-detail', value: path.rotor3 },
        { id: 'signal-rotor2', detail: 'rotor2-detail', value: path.rotor2 },
        { id: 'signal-rotor1', detail: 'rotor1-detail', value: path.rotor1 },
        { id: 'signal-reflector', detail: 'reflector-detail', value: path.reflector },
        { id: 'signal-rotor1b', detail: 'rotor1b-detail', value: path.rotor1b },
        { id: 'signal-rotor2b', detail: 'rotor2b-detail', value: path.rotor2b },
        { id: 'signal-rotor3b', detail: 'rotor3b-detail', value: path.rotor3b },
        { id: 'signal-plugboard2', detail: 'plug2-detail', value: path.plug2 },
        { id: 'signal-output', detail: 'output-detail', value: path.output }
    ];
    
    // Reset all components
    document.querySelectorAll('.signal-component').forEach(comp => {
        comp.classList.remove('active');
    });
    document.querySelectorAll('.signal-detail').forEach(detail => {
        detail.classList.remove('show');
        detail.textContent = '';
    });
    document.querySelectorAll('.signal-arrow').forEach(arrow => {
        arrow.classList.remove('active');
    });
    
    // Animate through components
    let delay = 0;
    components.forEach((comp, index) => {
        setTimeout(() => {
            const element = document.getElementById(comp.id);
            const detail = document.getElementById(comp.detail);
            
            element.classList.add('active');
            detail.textContent = comp.value;
            detail.classList.add('show');
            
            // Animate arrow
            if (index < components.length - 1) {
                const arrows = document.querySelectorAll('.signal-arrow');
                if (index < 6) {
                    arrows[index].classList.add('active');
                } else if (index < 10) {
                    arrows[index - 1].classList.add('active');
                }
            }
            
            // Animate plugboard connections
            if (comp.id.includes('plugboard') && path[comp.id.includes('1') ? 'plug1' : 'plug2'].includes('→')) {
                const [from, to] = comp.value.split(' → ');
                if (from !== to) {
                    const fromSocket = document.querySelector(`.plug-socket[data-letter="${from}"]`);
                    const toSocket = document.querySelector(`.plug-socket[data-letter="${to}"]`);
                    if (fromSocket) fromSocket.classList.add('signal-active');
                    if (toSocket) toSocket.classList.add('signal-active');
                    setTimeout(() => {
                        if (fromSocket) fromSocket.classList.remove('signal-active');
                        if (toSocket) toSocket.classList.remove('signal-active');
                    }, 500);
                }
            }
        }, delay);
        delay += 200;
    });
}

// Process entire text
function processText() {
    const input = document.getElementById('inputText').value.toUpperCase().replace(/[^A-Z]/g, '');
    const output = document.getElementById('outputText');
    output.value = '';
    
    // Save current state
    const savedState = JSON.parse(JSON.stringify(machineState));
    
    for (let char of input) {
        pressKey(char);
    }
    
    // Add to history
    addToHistory(input, output.value);
    
    // Restore rotor positions for decryption capability
    machineState.leftRotor.position = savedState.leftRotor.position;
    machineState.middleRotor.position = savedState.middleRotor.position;
    machineState.rightRotor.position = savedState.rightRotor.position;
    updateRotorDisplays();
}

// Add message to history
function addToHistory(input, output) {
    const timestamp = new Date().toLocaleString();
    messageHistory.unshift({
        timestamp,
        input,
        output,
        settings: JSON.parse(JSON.stringify(machineState))
    });
    
    // Keep only last 50 messages
    if (messageHistory.length > 50) {
        messageHistory.pop();
    }
    
    updateHistoryDisplay();
}

// Update history display
function updateHistoryDisplay() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '';
    
    messageHistory.forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
            <div class="timestamp">${item.timestamp}</div>
            <div>Input: ${item.input.substring(0, 50)}${item.input.length > 50 ? '...' : ''}</div>
            <div>Output: ${item.output.substring(0, 50)}${item.output.length > 50 ? '...' : ''}</div>
            <button onclick="loadHistoryItem(${index})" style="margin-top: 5px;">Load Settings</button>
        `;
        historyList.appendChild(historyItem);
    });
}

// Load history item
function loadHistoryItem(index) {
    const item = messageHistory[index];
    if (item) {
        machineState = JSON.parse(JSON.stringify(item.settings));
        updateUIFromState();
        document.getElementById('inputText').value = item.input;
        document.getElementById('outputText').value = '';
    }
}

// Clear history
function clearHistory() {
    messageHistory = [];
    updateHistoryDisplay();
}

// Update frequency analysis
function updateFrequencyAnalysis() {
    const text = analysisTab === 'input' ? 
        document.getElementById('inputText').value : 
        document.getElementById('outputText').value;
    
    const frequencies = calculateFrequencies(text.toUpperCase().replace(/[^A-Z]/g, ''));
    displayFrequencyChart(frequencies);
    
    // Calculate statistics
    const ioc = calculateIOC(text);
    const chi = calculateChiSquared(frequencies);
    
    document.getElementById('iocValue').textContent = ioc.toFixed(4);
    document.getElementById('chiSquared').textContent = chi.toFixed(2);
}

// Calculate letter frequencies
function calculateFrequencies(text) {
    const freq = {};
    for (let i = 0; i < 26; i++) {
        freq[String.fromCharCode(65 + i)] = 0;
    }
    
    for (let char of text) {
        if (freq[char] !== undefined) {
            freq[char]++;
        }
    }
    
    // Convert to percentages
    const total = text.length || 1;
    for (let letter in freq) {
        freq[letter] = (freq[letter] / total) * 100;
    }
    
    return freq;
}

// Display frequency chart
function displayFrequencyChart(frequencies) {
    const chart = document.getElementById('frequencyChart');
    chart.innerHTML = '';
    
    // English letter frequencies for comparison
    const englishFreq = {
        'A': 8.17, 'B': 1.29, 'C': 2.78, 'D': 4.25, 'E': 12.70, 'F': 2.23,
        'G': 2.02, 'H': 6.09, 'I': 6.97, 'J': 0.15, 'K': 0.77, 'L': 4.03,
        'M': 2.41, 'N': 6.75, 'O': 7.51, 'P': 1.93, 'Q': 0.10, 'R': 5.99,
        'S': 6.33, 'T': 9.06, 'U': 2.76, 'V': 0.98, 'W': 2.36, 'X': 0.15,
        'Y': 1.97, 'Z': 0.07
    };
    
    const maxFreq = Math.max(...Object.values(frequencies), ...Object.values(englishFreq));
    
    for (let letter in frequencies) {
        const bar = document.createElement('div');
        bar.className = 'freq-bar';
        
        const fill = document.createElement('div');
        fill.className = 'freq-bar-fill';
        fill.style.height = `${(frequencies[letter] / maxFreq) * 100}px`;
        fill.title = `${letter}: ${frequencies[letter].toFixed(2)}% (English: ${englishFreq[letter]}%)`;
        
        const label = document.createElement('div');
        label.className = 'freq-letter';
        label.textContent = letter;
        
        bar.appendChild(fill);
        bar.appendChild(label);
        chart.appendChild(bar);
    }
}

// Calculate Index of Coincidence
function calculateIOC(text) {
    text = text.toUpperCase().replace(/[^A-Z]/g, '');
    if (text.length < 2) return 0;
    
    const freq = {};
    for (let char of text) {
        freq[char] = (freq[char] || 0) + 1;
    }
    
    let sum = 0;
    for (let count of Object.values(freq)) {
        sum += count * (count - 1);
    }
    
    return sum / (text.length * (text.length - 1));
}

// Calculate Chi-squared statistic
function calculateChiSquared(frequencies) {
    const englishFreq = {
        'A': 8.17, 'B': 1.29, 'C': 2.78, 'D': 4.25, 'E': 12.70, 'F': 2.23,
        'G': 2.02, 'H': 6.09, 'I': 6.97, 'J': 0.15, 'K': 0.77, 'L': 4.03,
        'M': 2.41, 'N': 6.75, 'O': 7.51, 'P': 1.93, 'Q': 0.10, 'R': 5.99,
        'S': 6.33, 'T': 9.06, 'U': 2.76, 'V': 0.98, 'W': 2.36, 'X': 0.15,
        'Y': 1.97, 'Z': 0.07
    };
    
    let chi = 0;
    for (let letter in frequencies) {
        const expected = englishFreq[letter];
        const observed = frequencies[letter];
        chi += Math.pow(observed - expected, 2) / expected;
    }
    
    return chi;
}

// Show analysis tab
function showAnalysisTab(tab) {
    analysisTab = tab;
    document.querySelectorAll('#analysisSection .tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    updateFrequencyAnalysis();
}

// Show cryptanalysis tab
function showCryptTab(tab) {
    cryptTab = tab;
    document.querySelectorAll('#cryptanalysisSection .tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('cribDragTab').style.display = tab === 'cribdrag' ? 'block' : 'none';
    document.getElementById('bruteForceTab').style.display = tab === 'bruteforce' ? 'block' : 'none';
    document.getElementById('plugboardTab').style.display = tab === 'plugboard' ? 'block' : 'none';
}

// Perform crib attack
function performCribAttack() {
    const crib = document.getElementById('cribText').value.toUpperCase().replace(/[^A-Z]/g, '');
    const ciphertext = document.getElementById('cipherText').value.toUpperCase().replace(/[^A-Z]/g, '');
    const results = document.getElementById('cribResults');
    
    if (!crib || !ciphertext) {
        results.innerHTML = '<p style="color: #ff6666;">Please enter both crib and ciphertext.</p>';
        return;
    }
    
    results.innerHTML = '<p>Searching for crib positions...</p>';
    const matches = [];
    
    // Try all positions
    for (let pos = 0; pos <= ciphertext.length - crib.length; pos++) {
        let valid = true;
        const mapping = {};
        const reverseMapping = {};
        
        // Check if crib could match at this position
        for (let i = 0; i < crib.length; i++) {
            const plainChar = crib[i];
            const cipherChar = ciphertext[pos + i];
            
            // Enigma never encrypts a letter to itself
            if (plainChar === cipherChar) {
                valid = false;
                break;
            }
            
            // Check for consistent mapping
            if (mapping[plainChar] && mapping[plainChar] !== cipherChar) {
                valid = false;
                break;
            }
            if (reverseMapping[cipherChar] && reverseMapping[cipherChar] !== plainChar) {
                valid = false;
                break;
            }
            
            mapping[plainChar] = cipherChar;
            reverseMapping[cipherChar] = plainChar;
        }
        
        if (valid) {
            matches.push({
                position: pos,
                segment: ciphertext.substring(pos, pos + crib.length),
                mapping
            });
        }
    }
    
    // Display results
    results.innerHTML = `<h4>Found ${matches.length} possible positions:</h4>`;
    
    matches.forEach(match => {
        const result = document.createElement('div');
        result.className = 'attack-result match';
        result.innerHTML = `
            <strong>Position ${match.position}:</strong><br>
            Crib: ${crib}<br>
            Cipher: ${match.segment}<br>
            <button onclick="testCribPosition(${match.position}, '${crib}', '${ciphertext}')" style="margin-top: 5px;">Test This Position</button>
        `;
        results.appendChild(result);
    });
    
    if (matches.length === 0) {
        results.innerHTML += '<p style="color: #ff6666;">No valid positions found. The crib might not be in this ciphertext.</p>';
    }
}

// Test a specific crib position
function testCribPosition(position, crib, ciphertext) {
    // This would attempt to deduce rotor settings based on the crib
    // For demonstration, we'll show the mapping
    alert(`Testing position ${position}. In a full implementation, this would attempt to deduce rotor and plugboard settings.`);
}

// Brute force rotor positions
function bruteForceRotors() {
    const testPhrase = document.getElementById('testPhrase').value.toUpperCase().replace(/[^A-Z]/g, '');
    const results = document.getElementById('bruteResults');
    
    if (!testPhrase) {
        results.innerHTML = '<p style="color: #ff6666;">Please enter a test phrase.</p>';
        return;
    }
    
    results.innerHTML = '<p>Testing all 17,576 rotor positions...</p>';
    
    // Save current state
    const savedState = JSON.parse(JSON.stringify(machineState));
    const matches = [];
    
    // Test all positions (26^3 = 17,576)
    for (let l = 0; l < 26; l++) {
        for (let m = 0; m < 26; m++) {
            for (let r = 0; r < 26; r++) {
                // Set positions
                machineState.leftRotor.position = l;
                machineState.middleRotor.position = m;
                machineState.rightRotor.position = r;
                
                // Encrypt test phrase
                let output = '';
                const tempState = JSON.parse(JSON.stringify(machineState));
                
                for (let char of testPhrase) {
                    stepRotors();
                    const inputCode = char.charCodeAt(0) - 65;
                    const outputCode = encodeChar(inputCode);
                    output += String.fromCharCode(outputCode + 65);
                }
                
                // Check if output contains common patterns
                if (isLikelyPlaintext(output)) {
                    matches.push({
                        positions: [l, m, r],
                        output
                    });
                }
                
                // Restore state for next test
                machineState = JSON.parse(JSON.stringify(tempState));
            }
        }
    }
    
    // Restore original state
    machineState = savedState;
    updateRotorDisplays();
    
    // Display results
    results.innerHTML = `<h4>Found ${matches.length} potential matches:</h4>`;
    
    matches.slice(0, 20).forEach(match => {
        const [l, m, r] = match.positions;
        const result = document.createElement('div');
        result.className = 'attack-result match';
        result.innerHTML = `
            <strong>Positions: ${String.fromCharCode(65 + l)}${String.fromCharCode(65 + m)}${String.fromCharCode(65 + r)}</strong><br>
            Output: ${match.output}<br>
            <button onclick="setRotorPositions(${l}, ${m}, ${r})" style="margin-top: 5px;">Use These Settings</button>
        `;
        results.appendChild(result);
    });
}

// Check if text is likely plaintext
function isLikelyPlaintext(text) {
    // Simple heuristic: check for common bigrams
    const commonBigrams = ['TH', 'HE', 'IN', 'ER', 'AN', 'RE', 'ED', 'ON', 'ES', 'ST', 'EN', 'AT'];
    let score = 0;
    
    for (let i = 0; i < text.length - 1; i++) {
        const bigram = text.substring(i, i + 2);
        if (commonBigrams.includes(bigram)) {
            score++;
        }
    }
    
    return score > text.length / 10; // At least 10% common bigrams
}

// Set rotor positions
function setRotorPositions(l, m, r) {
    machineState.leftRotor.position = l;
    machineState.middleRotor.position = m;
    machineState.rightRotor.position = r;
    updateUIFromState();
}

// Analyze plugboard
function analyzePlugboard() {
    const input = document.getElementById('inputText').value.toUpperCase().replace(/[^A-Z]/g, '');
    const output = document.getElementById('outputText').value.toUpperCase().replace(/[^A-Z]/g, '');
    const results = document.getElementById('plugboardResults');
    
    if (!input || !output || input.length !== output.length) {
        results.innerHTML = '<p style="color: #ff6666;">Please process some text first.</p>';
        return;
    }
    
    results.innerHTML = '<h4>Plugboard Analysis:</h4>';
    
    // Analyze letter substitutions
    const substitutions = {};
    for (let i = 0; i < input.length; i++) {
        const inChar = input[i];
        const outChar = output[i];
        
        if (!substitutions[inChar]) {
            substitutions[inChar] = {};
        }
        substitutions[inChar][outChar] = (substitutions[inChar][outChar] || 0) + 1;
    }
    
    // Find consistent substitutions
    const suggestions = [];
    for (let letter in substitutions) {
        const subs = substitutions[letter];
        const total = Object.values(subs).reduce((a, b) => a + b, 0);
        
        for (let sub in subs) {
            const ratio = subs[sub] / total;
            if (ratio > 0.8 && letter !== sub) { // 80% consistency threshold
                suggestions.push({
                    from: letter,
                    to: sub,
                    confidence: ratio * 100
                });
            }
        }
    }
    
    // Display suggestions
    if (suggestions.length > 0) {
        results.innerHTML += '<p>Suggested plugboard connections based on pattern analysis:</p>';
        suggestions.forEach(sug => {
            const result = document.createElement('div');
            result.className = 'attack-result';
            result.innerHTML = `
                ${sug.from} ↔ ${sug.to} (${sug.confidence.toFixed(1)}% confidence)
                <button onclick="addPlugboardConnection('${sug.from}', '${sug.to}')" style="margin-left: 10px;">Add</button>
            `;
            results.appendChild(result);
        });
    } else {
        results.innerHTML += '<p>No clear plugboard patterns detected. Try processing more text.</p>';
    }
}

// Add plugboard connection
function addPlugboardConnection(a, b) {
    // Remove any existing connections
    if (machineState.plugboard[a]) {
        const oldPartner = machineState.plugboard[a];
        delete machineState.plugboard[a];
        delete machineState.plugboard[oldPartner];
        machineState.plugboardPairs = machineState.plugboardPairs.filter(
            pair => !(pair.includes(a) && pair.includes(oldPartner))
        );
    }
    if (machineState.plugboard[b]) {
        const oldPartner = machineState.plugboard[b];
        delete machineState.plugboard[b];
        delete machineState.plugboard[oldPartner];
        machineState.plugboardPairs = machineState.plugboardPairs.filter(
            pair => !(pair.includes(b) && pair.includes(oldPartner))
        );
    }
    
    // Add new connection
    machineState.plugboard[a] = b;
    machineState.plugboard[b] = a;
    machineState.plugboardPairs.push([a, b]);
    
    updateUIFromState();
}

// Educational mode - process with visualization
function processTextEducational() {
    const input = document.getElementById('inputText').value;
    const lastChar = input[input.length - 1];
    
    if (lastChar && /[A-Za-z]/.test(lastChar)) {
        const upperChar = lastChar.toUpperCase();
        pressKey(upperChar);
    }
}

// Show signal path (educational mode)
function showSignalPath(input, output) {
    // This would show the signal path through the machine
    // For brevity, showing a simple notification
    console.log(`Signal path: ${input} → Plugboard → Rotors → Reflector → Rotors → Plugboard → ${output}`);
}

// Clear all
function clearAll() {
    document.getElementById('inputText').value = '';
    document.getElementById('outputText').value = '';
    
    // Clear lamp
    document.querySelectorAll('.lamp').forEach(lamp => lamp.classList.remove('lit'));
}

// Reset machine to default
function resetMachine() {
    machineState = {
        leftRotor: { type: 'I', position: 0, ring: 0 },
        middleRotor: { type: 'II', position: 0, ring: 0 },
        rightRotor: { type: 'III', position: 0, ring: 0 },
        plugboard: {},
        plugboardPairs: []
    };
    
    // Update UI
    document.getElementById('leftRotorType').value = 'I';
    document.getElementById('middleRotorType').value = 'II';
    document.getElementById('rightRotorType').value = 'III';
    
    document.getElementById('leftPosition').value = 'A';
    document.getElementById('middlePosition').value = 'A';
    document.getElementById('rightPosition').value = 'A';
    
    document.getElementById('leftRing').value = '1';
    document.getElementById('middleRing').value = '1';
    document.getElementById('rightRing').value = '1';
    
    // Clear plugboard
    document.querySelectorAll('.plug-socket').forEach(socket => {
        socket.classList.remove('connected');
    });
    
    updateRotorDisplays();
    updatePlugboardDisplay();
    clearAll();
}

// Copy output to clipboard
function copyOutput() {
    const output = document.getElementById('outputText');
    output.select();
    document.execCommand('copy');
    
    // Visual feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    setTimeout(() => {
        button.textContent = originalText;
    }, 2000);
}

// Settings modal
function showSettings() {
    document.getElementById('settingsModal').style.display = 'flex';
}

function closeSettings() {
    document.getElementById('settingsModal').style.display = 'none';
}

// Configuration management
function saveConfig() {
    const config = {
        rotors: {
            left: machineState.leftRotor,
            middle: machineState.middleRotor,
            right: machineState.rightRotor
        },
        plugboard: machineState.plugboardPairs
    };
    
    localStorage.setItem('enigmaConfig', JSON.stringify(config));
    alert('Configuration saved!');
}

function loadConfig() {
    const saved = localStorage.getItem('enigmaConfig');
    if (saved) {
        const config = JSON.parse(saved);
        
        // Load rotor settings
        machineState.leftRotor = config.rotors.left;
        machineState.middleRotor = config.rotors.middle;
        machineState.rightRotor = config.rotors.right;
        
        // Load plugboard
        machineState.plugboard = {};
        machineState.plugboardPairs = [];
        
        for (let pair of config.plugboard) {
            machineState.plugboard[pair[0]] = pair[1];
            machineState.plugboard[pair[1]] = pair[0];
            machineState.plugboardPairs.push(pair);
        }
        
        // Update UI
        updateUIFromState();
        alert('Configuration loaded!');
    } else {
        alert('No saved configuration found!');
    }
}

function exportConfig() {
    const config = {
        rotors: {
            left: machineState.leftRotor,
            middle: machineState.middleRotor,
            right: machineState.rightRotor
        },
        plugboard: machineState.plugboardPairs
    };
    
    const configCode = btoa(JSON.stringify(config));
    document.getElementById('configCode').value = configCode;
}

function importConfig() {
    try {
        const configCode = document.getElementById('configCode').value;
        const config = JSON.parse(atob(configCode));
        
        // Load configuration
        machineState.leftRotor = config.rotors.left;
        machineState.middleRotor = config.rotors.middle;
        machineState.rightRotor = config.rotors.right;
        
        // Load plugboard
        machineState.plugboard = {};
        machineState.plugboardPairs = [];
        
        for (let pair of config.plugboard) {
            machineState.plugboard[pair[0]] = pair[1];
            machineState.plugboard[pair[1]] = pair[0];
            machineState.plugboardPairs.push(pair);
        }
        
        updateUIFromState();
        closeSettings();
        alert('Configuration imported successfully!');
    } catch (e) {
        alert('Invalid configuration code!');
    }
}

function updateUIFromState() {
    // Update rotor UI
    document.getElementById('leftRotorType').value = machineState.leftRotor.type;
    document.getElementById('middleRotorType').value = machineState.middleRotor.type;
    document.getElementById('rightRotorType').value = machineState.rightRotor.type;
    
    document.getElementById('leftPosition').value = String.fromCharCode(65 + machineState.leftRotor.position);
    document.getElementById('middlePosition').value = String.fromCharCode(65 + machineState.middleRotor.position);
    document.getElementById('rightPosition').value = String.fromCharCode(65 + machineState.rightRotor.position);
    
    document.getElementById('leftRing').value = machineState.leftRotor.ring + 1;
    document.getElementById('middleRing').value = machineState.middleRotor.ring + 1;
    document.getElementById('rightRing').value = machineState.rightRotor.ring + 1;
    
    // Update plugboard UI
    document.querySelectorAll('.plug-socket').forEach(socket => {
        socket.classList.remove('connected');
    });
    
    for (let pair of machineState.plugboardPairs) {
        document.querySelector(`.plug-socket[data-letter="${pair[0]}"]`).classList.add('connected');
        document.querySelector(`.plug-socket[data-letter="${pair[1]}"]`).classList.add('connected');
    }
    
    updateRotorDisplays();
    updatePlugboardDisplay();
}

// Load preset configurations
function loadPreset(preset) {
    const presets = {
        default: {
            rotors: {
                left: { type: 'I', position: 0, ring: 0 },
                middle: { type: 'II', position: 0, ring: 0 },
                right: { type: 'III', position: 0, ring: 0 }
            },
            plugboard: []
        },
        historical1: {
            rotors: {
                left: { type: 'IV', position: 14, ring: 3 },
                middle: { type: 'V', position: 8, ring: 11 },
                right: { type: 'II', position: 24, ring: 19 }
            },
            plugboard: [['A','R'], ['G','K'], ['O','X']]
        },
        historical2: {
            rotors: {
                left: { type: 'III', position: 6, ring: 7 },
                middle: { type: 'I', position: 22, ring: 2 },
                right: { type: 'V', position: 13, ring: 15 }
            },
            plugboard: [['B','J'], ['C','V'], ['D','P'], ['E','Z'], ['F','H']]
        }
    };
    
    const config = presets[preset];
    if (config) {
        // Load configuration
        machineState.leftRotor = config.rotors.left;
        machineState.middleRotor = config.rotors.middle;
        machineState.rightRotor = config.rotors.right;
        
        // Load plugboard
        machineState.plugboard = {};
        machineState.plugboardPairs = [];
        
        for (let pair of config.plugboard) {
            machineState.plugboard[pair[0]] = pair[1];
            machineState.plugboard[pair[1]] = pair[0];
            machineState.plugboardPairs.push(pair);
        }
        
        updateUIFromState();
        closeSettings();
    }
}

// Initialize on load
window.onload = initializeMachine;

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('settingsModal');
    if (event.target === modal) {
        closeSettings();
    }
}
</script>
</body>
</html>
